---
- name: Ping Servers
  hosts: main_group
  tasks:
    - name: Ping servers
      ping:
  tags: [configure, deploy, check]

- name: GIT
  hosts: main_group
  tasks:
    - name: "Git clone repo"
      git:
        repo: https://github.com/JackSpades17/test_service
        dest: "{{ path_service }}"
        clone: yes
        update: yes
  tags: [configure, deploy]

- name: Install Docker
  hosts: main_group
  tasks:
    - name: update and upgrade apt
      apt:
        upgrade: yes
        update_cache: yes

    - name: "Check/Install docker"
      apt: 
        name: "docker.io"
        state: present
        update_cache: true

    - name: "Check/Install docker-compose"
      apt: 
        name: "docker-compose"
        state: present
        update_cache: true

    - name: "Start docker service"
      service:
        name: "docker"
        state: started
    become: true
  tags: configure

- name: Restart app after deploy
  hosts: main_group
  tasks:
    - name: "Docker Stop"
      shell: 
        cmd: "docker-compose stop"
        chdir: "{{ path_service }}"
      ignore_errors: yes
    - name: "Docker Start"
      shell: 
        cmd: "docker-compose start"
        chdir: "{{ path_service }}"
    become: true
  tags: deploy

- name: Build app
  hosts: main_group
  tasks:
    - name: "Docker Build"
      shell: 
        cmd: "docker build -f Dockerfile -t test_zone ."
        chdir: "{{ path_service }}"
      become: true
  tags: configure

- name: Start app
  hosts: main_group
  tasks:
    - name: "Start app in Docker"
      shell: 
        cmd: "docker-compose up -d"
        chdir: "{{ path_service }}"
      become: true
  tags: configure


    
  

